<!DOCTYPE html>
<html lang="">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"mshrimp.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="u-boot引导kernel启动过程u-boot引导Linux kernel启动的过程；">
<meta property="og:type" content="article">
<meta property="og:title" content="u-boot引导kernel启动过程">
<meta property="og:url" content="http://mshrimp.github.io/2020/04/19/u-boot%E5%BC%95%E5%AF%BCkernel%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B/index.html">
<meta property="og:site_name" content="Mshrimp blog">
<meta property="og:description" content="u-boot引导kernel启动过程u-boot引导Linux kernel启动的过程；">
<meta property="article:published_time" content="2020-04-19T13:54:40.000Z">
<meta property="article:modified_time" content="2020-05-06T14:00:50.618Z">
<meta property="article:author" content="micro虾米">
<meta property="article:tag" content="u-boot">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://mshrimp.github.io/2020/04/19/u-boot%E5%BC%95%E5%AF%BCkernel%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'default'
  };
</script>

  <title>u-boot引导kernel启动过程 | Mshrimp blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Mshrimp blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">micro虾米</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="http://mshrimp.github.io/2020/04/19/u-boot%E5%BC%95%E5%AF%BCkernel%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="micro虾米">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mshrimp blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          u-boot引导kernel启动过程
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-04-19 21:54:40" itemprop="dateCreated datePublished" datetime="2020-04-19T21:54:40+08:00">2020-04-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-05-06 22:00:50" itemprop="dateModified" datetime="2020-05-06T22:00:50+08:00">2020-05-06</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="u-boot引导kernel启动过程"><a href="#u-boot引导kernel启动过程" class="headerlink" title="u-boot引导kernel启动过程"></a>u-boot引导kernel启动过程</h2><p>u-boot引导Linux kernel启动的过程；</p>
<a id="more"></a>



<h3 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h3><p>[TOC]</p>
<h3 id="bootm命令"><a href="#bootm命令" class="headerlink" title="bootm命令"></a>bootm命令</h3><p>bootm命令用于启动操作系统映像；bootm命令从映像文件的头部获取信息；包括：映像文件的CPU架构、操作系统类型、映像类型、压缩方式、映像文件在内存中的加载地址、映像文件运行的入口地址、映像文件名等；</p>
<p>bootm将映像文件加载到指定的地址，解压映像并传递必要的内核启动参数给内核，最后跳转到入口地址进入内核，开始执行内核；</p>
<p>bootm命令执行有三个步骤：</p>
<p>解压Linux内核映像并将其加载到RAM中</p>
<p>将ramdisk映像加载到RAM中</p>
<p>将控制权交给内核，并向内核传递ramdisk在RAM中的位置和大小等信息</p>
<p>将映像文件加载到RAM中时，需要确保映像文件的加载地址，不能与内核的位置有重叠；</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// cmd/bootm.c</span></span><br><span class="line">U_BOOT_CMD(</span><br><span class="line">    bootm,  CONFIG_SYS_MAXARGS, <span class="number">1</span>,  do_bootm,</span><br><span class="line">    <span class="string">"boot application image from memory"</span>, bootm_help_text</span><br><span class="line">);</span><br></pre></td></tr></table></figure>




<pre class="mermaid">graph TB
    bootm(bootm)-->do_bootm(do_bootm)</pre>





<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">do_bootm</span><br><span class="line">　　-&gt;do_bootm_states</span><br><span class="line">　　　　-&gt;bootm_start /bootm_find_os /bootm_find_other</span><br><span class="line">　　　　　　-&gt;bootm_load_os</span><br><span class="line">　　　　　　-&gt;boot_fn = bootm_os_get_boot_func(images-&gt;os.os);</span><br><span class="line">　　　　　　　　([IH_OS_LINUX] = do_bootm_linux,)　　</span><br><span class="line">　　　　　　-&gt;boot_selected_os</span><br><span class="line">　　　　　　　　-&gt;do_bootm_linux</span><br><span class="line">　　　　　　　　　　-&gt;boot_prep_linux</span><br><span class="line">　　　　　　　　　　　　-&gt;image_setup_linux</span><br><span class="line">　　　　　　　　　　　　　　-&gt;boot_fdt_add_mem_rsv_regions</span><br><span class="line">　　　　　　　　　　　　　　-&gt;boot_get_cmdline</span><br><span class="line">　　　　　　　　　　　　　　-&gt;boot_relocate_fdt</span><br><span class="line">　　　　　　　　　　　　　　-&gt;image_setup_libfdt</span><br><span class="line">　　　　　　　　　　　　-&gt;boot_jump_linux</span><br><span class="line">　　　　　　　　　　　　　　-&gt;r2 = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)images-&gt;ft_addr;</span><br><span class="line">　　　　　　　　　　　　　　-&gt;kernel_entry(<span class="number">0</span>, machid, r2);</span><br></pre></td></tr></table></figure>








<h4 id="do-bootm"><a href="#do-bootm" class="headerlink" title="do_bootm"></a>do_bootm</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// cmd/bootm.c</span></span><br><span class="line"><span class="comment">/*******************************************************************/</span></span><br><span class="line"><span class="comment">/* bootm - boot application image from image in memory */</span></span><br><span class="line"><span class="comment">/*******************************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">do_bootm</span><span class="params">(<span class="keyword">cmd_tbl_t</span> *cmdtp, <span class="keyword">int</span> flag, <span class="keyword">int</span> argc, <span class="keyword">char</span> * <span class="keyword">const</span> argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/* determine if we have a sub command */</span></span><br><span class="line">    argc--; argv++;</span><br><span class="line">    <span class="keyword">if</span> (argc &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">char</span> *endp;</span><br><span class="line"></span><br><span class="line">        simple_strtoul(argv[<span class="number">0</span>], &amp;endp, <span class="number">16</span>);</span><br><span class="line">        <span class="comment">/* endp pointing to NULL means that argv[0] was just a</span></span><br><span class="line"><span class="comment">         * valid number, pass it along to the normal bootm processing</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * If endp is ':' or '#' assume a FIT identifier so pass</span></span><br><span class="line"><span class="comment">         * along for normal processing.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Right now we assume the first arg should never be '-'</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> ((*endp != <span class="number">0</span>) &amp;&amp; (*endp != <span class="string">':'</span>) &amp;&amp; (*endp != <span class="string">'#'</span>))</span><br><span class="line">            <span class="keyword">return</span> do_bootm_subcommand(cmdtp, flag, argc, argv);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> do_bootm_states(cmdtp, flag, argc, argv, BOOTM_STATE_START |</span><br><span class="line">        BOOTM_STATE_FINDOS | BOOTM_STATE_FINDOTHER |</span><br><span class="line">        BOOTM_STATE_LOADOS |</span><br><span class="line">#ifdef CONFIG_SYS_BOOT_RAMDISK_HIGH</span><br><span class="line">        BOOTM_STATE_RAMDISK |</span><br><span class="line">#endif</span><br><span class="line">        BOOTM_STATE_OS_PREP | BOOTM_STATE_OS_FAKE_GO |</span><br><span class="line">        BOOTM_STATE_OS_GO, &amp;images, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




<pre class="mermaid">graph LR
    do_bootm(do_bootm)-->do_bootm_states(do_bootm_states)
    do_bootm-->do_bootm_subcommand(do_bootm_subcommand)-->do_bootm_states</pre>






<p>bootm命令执行的核心操作由do_bootm_states()函数来完成；</p>
<p>do_bootm_states()函数操作，是由参数states来决定的；</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// include/image.h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BOOTM_STATE_START   (0x00000001)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BOOTM_STATE_FINDOS  (0x00000002)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BOOTM_STATE_FINDOTHER   (0x00000004)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BOOTM_STATE_LOADOS  (0x00000008)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BOOTM_STATE_RAMDISK (0x00000010)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BOOTM_STATE_FDT     (0x00000020)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BOOTM_STATE_OS_CMDLINE  (0x00000040)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BOOTM_STATE_OS_BD_T (0x00000080)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BOOTM_STATE_OS_PREP (0x00000100)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BOOTM_STATE_OS_FAKE_GO  (0x00000200)    <span class="comment">/* 'Almost' run the OS */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BOOTM_STATE_OS_GO   (0x00000400)</span></span><br></pre></td></tr></table></figure>




<p>do_bootm_states()函数的参数images，用来表示bootm命令启动kernel的一些信息，包含了指向os、initrd、fdt的映像信息；是全局变量：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// common/bootm.c</span></span><br><span class="line"><span class="keyword">bootm_headers_t</span> images;     <span class="comment">/* pointers to os/initrd/fdt images */</span></span><br></pre></td></tr></table></figure>






<h4 id="do-bootm-states"><a href="#do-bootm-states" class="headerlink" title="do_bootm_states"></a>do_bootm_states</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// common/bootm.c</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">do_bootm_states</span><span class="params">(<span class="keyword">cmd_tbl_t</span> *cmdtp, <span class="keyword">int</span> flag, <span class="keyword">int</span> argc, <span class="keyword">char</span> * <span class="keyword">const</span> argv[],</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> states, <span class="keyword">bootm_headers_t</span> *images, <span class="keyword">int</span> boot_progress)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    boot_os_fn *boot_fn;</span><br><span class="line">    ulong iflag = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>, need_boot_fn;</span><br><span class="line">    </span><br><span class="line">    images-&gt;state |= states;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (states &amp; BOOTM_STATE_START)</span><br><span class="line">        ret = bootm_start(cmdtp, flag, argc, argv);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!ret &amp;&amp; (states &amp; BOOTM_STATE_FINDOS))</span><br><span class="line">        ret = bootm_find_os(cmdtp, flag, argc, argv);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!ret &amp;&amp; (states &amp; BOOTM_STATE_FINDOTHER))</span><br><span class="line">        ret = bootm_find_other(cmdtp, flag, argc, argv);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Load the OS */</span></span><br><span class="line">    <span class="keyword">if</span> (!ret &amp;&amp; (states &amp; BOOTM_STATE_LOADOS)) &#123;</span><br><span class="line">        iflag = bootm_disable_interrupts();</span><br><span class="line">        ret = bootm_load_os(images, <span class="number">0</span>);</span><br><span class="line">		......</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Relocate the ramdisk */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SYS_BOOT_RAMDISK_HIGH</span></span><br><span class="line">    <span class="keyword">if</span> (!ret &amp;&amp; (states &amp; BOOTM_STATE_RAMDISK)) &#123;</span><br><span class="line">        ulong rd_len = images-&gt;rd_end - images-&gt;rd_start;</span><br><span class="line"></span><br><span class="line">        ret = boot_ramdisk_high(&amp;images-&gt;lmb, images-&gt;rd_start,</span><br><span class="line">            rd_len, &amp;images-&gt;initrd_start, &amp;images-&gt;initrd_end);</span><br><span class="line">		......</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> IMAGE_ENABLE_OF_LIBFDT &amp;&amp; defined(CONFIG_LMB)</span></span><br><span class="line">    <span class="keyword">if</span> (!ret &amp;&amp; (states &amp; BOOTM_STATE_FDT)) &#123;</span><br><span class="line">        boot_fdt_add_mem_rsv_regions(&amp;images-&gt;lmb, images-&gt;ft_addr);</span><br><span class="line">        ret = boot_relocate_fdt(&amp;images-&gt;lmb, &amp;images-&gt;ft_addr,</span><br><span class="line">                    &amp;images-&gt;ft_len);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	......</span><br><span class="line">    boot_fn = bootm_os_get_boot_func(images-&gt;os.os);</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> (!ret &amp;&amp; (states &amp; BOOTM_STATE_OS_PREP)) &#123;</span><br><span class="line">        ret = boot_fn(BOOTM_STATE_OS_PREP, argc, argv, images);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!ret &amp;&amp; (states &amp; BOOTM_STATE_OS_PREP)) &#123;</span><br><span class="line">        ret = boot_fn(BOOTM_STATE_OS_PREP, argc, argv, images);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_TRACE</span></span><br><span class="line">    <span class="comment">/* Pretend to run the OS, then run a user command */</span></span><br><span class="line">    <span class="keyword">if</span> (!ret &amp;&amp; (states &amp; BOOTM_STATE_OS_FAKE_GO)) &#123;</span><br><span class="line">        <span class="keyword">char</span> *cmd_list = env_get(<span class="string">"fakegocmd"</span>);</span><br><span class="line"></span><br><span class="line">        ret = boot_selected_os(argc, argv, BOOTM_STATE_OS_FAKE_GO,</span><br><span class="line">                images, boot_fn);</span><br><span class="line">        <span class="keyword">if</span> (!ret &amp;&amp; cmd_list)</span><br><span class="line">            ret = run_command_list(cmd_list, <span class="number">-1</span>, flag);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	......</span><br><span class="line">    <span class="comment">/* Now run the OS! We hope this doesn't return */</span></span><br><span class="line">    <span class="keyword">if</span> (!ret &amp;&amp; (states &amp; BOOTM_STATE_OS_GO))</span><br><span class="line">        ret = boot_selected_os(argc, argv, BOOTM_STATE_OS_GO,</span><br><span class="line">                images, boot_fn);</span><br><span class="line">	......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>






<pre class="mermaid">graph LR
    do_bootm_states(do_bootm_states)-->states(states)
    states--BOOTM_STATE_START-->bootm_start(bootm_start)
    states--BOOTM_STATE_FINDOS-->bootm_find_os(bootm_find_os)
    states--BOOTM_STATE_FINDOTHER-->bootm_find_other(bootm_find_other)
    states--BOOTM_STATE_LOADOS-->bootm_load_os(bootm_load_os)
    states--BOOTM_STATE_RAMDISK-->boot_ramdisk_high(boot_ramdisk_high)
    states--BOOTM_STATE_FDT-->boot_relocate_fdt(boot_relocate_fdt)
    states--BOOTM_STATE_OS_PREP-->boot_fn(boot_fn)
    states--BOOTM_STATE_OS_FAKE_GO-->boot_selected_os1(boot_selected_os)
    states--BOOTM_STATE_OS_GO-->boot_selected_os2(boot_selected_os)</pre>








<h4 id="bootm-start"><a href="#bootm-start" class="headerlink" title="bootm_start"></a>bootm_start</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// common/bootm.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">bootm_start</span><span class="params">(<span class="keyword">cmd_tbl_t</span> *cmdtp, <span class="keyword">int</span> flag, <span class="keyword">int</span> argc,</span></span></span><br><span class="line"><span class="function"><span class="params">               <span class="keyword">char</span> * <span class="keyword">const</span> argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">memset</span>((<span class="keyword">void</span> *)&amp;images, <span class="number">0</span>, <span class="keyword">sizeof</span>(images));</span><br><span class="line">    images.verify = env_get_yesno(<span class="string">"verify"</span>);</span><br><span class="line"></span><br><span class="line">    boot_start_lmb(&amp;images);</span><br><span class="line"></span><br><span class="line">    bootstage_mark_name(BOOTSTAGE_ID_BOOTM_START, <span class="string">"bootm_start"</span>);</span><br><span class="line">    images.state = BOOTM_STATE_START;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h4 id="bootm-find-os"><a href="#bootm-find-os" class="headerlink" title="bootm_find_os"></a>bootm_find_os</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">bootm_find_os</span><span class="params">(<span class="keyword">cmd_tbl_t</span> *cmdtp, <span class="keyword">int</span> flag, <span class="keyword">int</span> argc,</span></span></span><br><span class="line"><span class="function"><span class="params">             <span class="keyword">char</span> * <span class="keyword">const</span> argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">void</span> *os_hdr;</span><br><span class="line">    <span class="keyword">bool</span> ep_found = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* get kernel image header, start address and length */</span></span><br><span class="line">    os_hdr = boot_get_kernel(cmdtp, flag, argc, argv,</span><br><span class="line">            &amp;images, &amp;images.os.image_start, &amp;images.os.image_len);</span><br><span class="line">    <span class="keyword">if</span> (images.os.image_len == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"ERROR: can't get kernel image!\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;   </span><br><span class="line"></span><br><span class="line">    <span class="comment">/* get image parameters */</span></span><br><span class="line">    <span class="keyword">switch</span> (genimg_get_format(os_hdr)) &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> CONFIG_IS_ENABLED(LEGACY_IMAGE_FORMAT)</span></span><br><span class="line">    <span class="keyword">case</span> IMAGE_FORMAT_LEGACY:</span><br><span class="line">        images.os.type = image_get_type(os_hdr);</span><br><span class="line">        images.os.comp = image_get_comp(os_hdr);</span><br><span class="line">        images.os.os = image_get_os(os_hdr);</span><br><span class="line"></span><br><span class="line">        images.os.<span class="built_in">end</span> = image_get_image_end(os_hdr);</span><br><span class="line">        images.os.load = image_get_load(os_hdr);</span><br><span class="line">        images.os.arch = image_get_arch(os_hdr);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    ......</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (images.legacy_hdr_valid) &#123;</span><br><span class="line">        images.ep = image_get_ep(&amp;images.legacy_hdr_os_copy);</span><br><span class="line">    &#125;</span><br><span class="line">	......</span><br><span class="line">    images.os.start = map_to_sysmem(os_hdr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<pre class="mermaid">graph LR
    bootm_find_os(bootm_find_os)-->boot_get_kernel(boot_get_kernel)
    boot_get_kernel-->images_os1(images.os)
    images_os1-->image_start(image_start)
    images_os1-->image_len(image_len)
    bootm_find_os--IMAGE_FORMAT_LEGACY-->images_os(images.os)
    images_os-->type(type)
    images_os-->comp(comp)
    images_os-->os(os)
    images_os-->start(start)
    images_os-->endend(end)
    images_os-->load(load)
    images_os-->arch(arch)</pre>



<h5 id="boot-get-kernel"><a href="#boot-get-kernel" class="headerlink" title="boot_get_kernel"></a>boot_get_kernel</h5><p>boot_get_kernel()函数，获取内核映像的头、起始地址、长度；</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// common/bootm_os.c</span></span><br><span class="line"><span class="function">boot_os_fn *<span class="title">bootm_os_get_boot_func</span><span class="params">(<span class="keyword">int</span> os)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_NEEDS_MANUAL_RELOC</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">bool</span> relocated;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!relocated) &#123;</span><br><span class="line">        <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* relocate boot function table */</span></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ARRAY_SIZE(boot_os); i++)</span><br><span class="line">            <span class="keyword">if</span> (boot_os[i] != <span class="literal">NULL</span>)</span><br><span class="line">                boot_os[i] += gd-&gt;reloc_off;</span><br><span class="line"></span><br><span class="line">        relocated = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">return</span> boot_os[os];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>






<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// common/bootm_os.c</span></span><br><span class="line"><span class="keyword">static</span> boot_os_fn *boot_os[] = &#123;</span><br><span class="line">    [IH_OS_U_BOOT] = do_bootm_standalone,</span><br><span class="line">#ifdef CONFIG_BOOTM_LINUX</span><br><span class="line">    [IH_OS_LINUX] = do_bootm_linux,</span><br><span class="line">#endif</span><br><span class="line">......</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>




<p>u-boot中支持bootm命令需要打开CONFIG_BOOTM_LINUX和CONFIG_CMD_BOOTM配置，即：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_BOOTM_LINUX&#x3D;y</span><br></pre></td></tr></table></figure>




<pre class="mermaid">graph TB
    do_bootm_states(do_bootm_states)
    -->bootm_os_get_boot_func(bootm_os_get_boot_func)
    -->boot_os("boot_os[os]")
    -->do_bootm_linux(do_bootm_linux)</pre>






<h4 id="image"><a href="#image" class="headerlink" title="image"></a>image</h4><p>bootm_headers_t结构是用来表示bootm命令启动kernel的一些信息的结构体，包含了指向os、initrd、fdt的映像信息；</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// common/bootm.c</span></span><br><span class="line"><span class="keyword">bootm_headers_t</span> images;     <span class="comment">/* pointers to os/initrd/fdt images */</span></span><br></pre></td></tr></table></figure>


<p>bootm命令中，会根据参数以及参数指向的映像来填充bootm_headers_t结构体中的成员；最后再使用这个结构体中的信息填充kernel启动信息，并跳转到kernel执行；</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// include/image.h</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Legacy and FIT format headers used by do_bootm() and do_bootm_&lt;os&gt;()</span></span><br><span class="line"><span class="comment"> * routines.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">bootm_headers</span> &#123;</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Legacy os image header, if it is a multi component image</span></span><br><span class="line"><span class="comment">     * then boot_get_ramdisk() and get_fdt() will attempt to get</span></span><br><span class="line"><span class="comment">     * data from second and third component accordingly.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">image_header_t</span>  *legacy_hdr_os;     <span class="comment">/* image header pointer */</span></span><br><span class="line">    <span class="keyword">image_header_t</span>  legacy_hdr_os_copy; <span class="comment">/* header copy */</span></span><br><span class="line">    ulong       legacy_hdr_valid;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> IMAGE_ENABLE_FIT</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>  *fit_uname_cfg; <span class="comment">/* configuration node unit name */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span>        *fit_hdr_os;    <span class="comment">/* os FIT image header */</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>  *fit_uname_os;  <span class="comment">/* os subimage node unit name */</span></span><br><span class="line">    <span class="keyword">int</span>     fit_noffset_os; <span class="comment">/* os subimage node offset */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span>        *fit_hdr_rd;    <span class="comment">/* init ramdisk FIT image header */</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>  *fit_uname_rd;  <span class="comment">/* init ramdisk subimage node unit name */</span></span><br><span class="line">    <span class="keyword">int</span>     fit_noffset_rd; <span class="comment">/* init ramdisk subimage node offset */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span>        *fit_hdr_fdt;   <span class="comment">/* FDT blob FIT image header */</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>  *fit_uname_fdt; <span class="comment">/* FDT blob subimage node unit name */</span></span><br><span class="line">    <span class="keyword">int</span>     fit_noffset_fdt;<span class="comment">/* FDT blob subimage node offset */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span>        *fit_hdr_setup; <span class="comment">/* x86 setup FIT image header */</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>  *fit_uname_setup; <span class="comment">/* x86 setup subimage node name */</span></span><br><span class="line">    <span class="keyword">int</span>     fit_noffset_setup;<span class="comment">/* x86 setup subimage node offset */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> USE_HOSTCC</span></span><br><span class="line">    <span class="keyword">image_info_t</span>    os;     <span class="comment">/* os image info */</span></span><br><span class="line">    ulong       ep;     <span class="comment">/* entry point of OS */</span></span><br><span class="line"></span><br><span class="line">    ulong       rd_start, rd_end;<span class="comment">/* ramdisk start/end */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span>        *ft_addr;   <span class="comment">/* flat dev tree address */</span></span><br><span class="line">    ulong       ft_len;     <span class="comment">/* length of flat device tree */</span></span><br><span class="line"></span><br><span class="line">    ulong       initrd_start;</span><br><span class="line">    ulong       initrd_end;</span><br><span class="line">    ulong       cmdline_start;</span><br><span class="line">    ulong       cmdline_end;</span><br><span class="line">    <span class="keyword">bd_t</span>        *kbd;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span>     verify;     <span class="comment">/* env_get("verify")[0] != 'n' */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BOOTM_STATE_START   (0x00000001)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BOOTM_STATE_FINDOS  (0x00000002)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BOOTM_STATE_FINDOTHER   (0x00000004)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BOOTM_STATE_LOADOS  (0x00000008)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BOOTM_STATE_RAMDISK (0x00000010)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BOOTM_STATE_FDT     (0x00000020)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BOOTM_STATE_OS_CMDLINE  (0x00000040)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BOOTM_STATE_OS_BD_T (0x00000080)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BOOTM_STATE_OS_PREP (0x00000100)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BOOTM_STATE_OS_FAKE_GO  (0x00000200)    <span class="comment">/* 'Almost' run the OS */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BOOTM_STATE_OS_GO   (0x00000400)</span></span><br><span class="line">    <span class="keyword">int</span>     state;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_LMB</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">lmb</span>  <span class="title">lmb</span>;</span>        <span class="comment">/* for memory mgmt */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125; <span class="keyword">bootm_headers_t</span>;</span><br></pre></td></tr></table></figure>












<h4 id="do-bootm-linux"><a href="#do-bootm-linux" class="headerlink" title="do_bootm_linux"></a>do_bootm_linux</h4><p>为了能够正常调用do_bootm_linux函数，需要打开CONFIG_CMD_BOOTM配置；</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_CMD_BOOTM&#x3D;y</span><br></pre></td></tr></table></figure>


<p>因为do_bootm_linux函数是平台相关的函数，需要在arm平台下打开对应的CONFIG_CMD_BOOTM配置；</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">arch&#x2F;arm&#x2F;lib&#x2F;Makefile:34:obj-$(CONFIG_CMD_BOOTM) +&#x3D; bootm.o</span><br></pre></td></tr></table></figure>








<pre class="mermaid">graph TB
    do_bootm_linux(do_bootm_linux)-->boot_prep_linux(boot_prep_linux)
    do_bootm_linux-->boot_jump_linux(boot_jump_linux)</pre>








<p>do_bootm_linux()函数是bootm实现的主要入口点</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// arch/arm/lib/bootm.c</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">do_bootm_linux</span><span class="params">(<span class="keyword">int</span> flag, <span class="keyword">int</span> argc, <span class="keyword">char</span> * <span class="keyword">const</span> argv[],</span></span></span><br><span class="line"><span class="function"><span class="params">           <span class="keyword">bootm_headers_t</span> *images)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (flag &amp; BOOTM_STATE_OS_PREP) &#123;</span><br><span class="line">        boot_prep_linux(images);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (flag &amp; (BOOTM_STATE_OS_GO | BOOTM_STATE_OS_FAKE_GO)) &#123;</span><br><span class="line">        boot_jump_linux(images, flag);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    boot_prep_linux(images);</span><br><span class="line">    boot_jump_linux(images, flag);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>














<h3 id="u-boot给Kernel传参"><a href="#u-boot给Kernel传参" class="headerlink" title="u-boot给Kernel传参"></a>u-boot给Kernel传参</h3><p>嵌入式环境的Linux内核运行需要通过u-boot来加载并启动运行，在内核启动之前，由u-boot来提供Kernel的运行环境，同时将启动需要的参数传递给Kernel；</p>
<p><strong>传参方法</strong>：将要传递的参数，封装成一个结构体，把这个结构体连续存储在内存的一片区域，将内存区域的物理地址传递给内核，内核在启动时从指定的物理地址中读取参数，并通过parse_tags()来解析参数，就完成了给kernel传参；</p>
<p>u-boot中定义这个结构体为tag：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// arch/arm/include/asm/setup.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tag</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tag_header</span> <span class="title">hdr</span>;</span></span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">tag_core</span>     <span class="title">core</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">tag_mem32</span>    <span class="title">mem</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">tag_videotext</span>    <span class="title">videotext</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">tag_ramdisk</span>  <span class="title">ramdisk</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">tag_initrd</span>   <span class="title">initrd</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">tag_serialnr</span> <span class="title">serialnr</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">tag_revision</span> <span class="title">revision</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">tag_videolfb</span> <span class="title">videolfb</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">tag_cmdline</span>  <span class="title">cmdline</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">tag_acorn</span>    <span class="title">acorn</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">tag_memclk</span>   <span class="title">memclk</span>;</span></span><br><span class="line">    &#125; u;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>


<p>这个数据结构在u-boot和kernel中都有定义，并且必须保持一致；</p>
<p>其中tag_header为tag头，表明tag的类型和大小，类型是用来区别tag之间不同的处理函数；</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// arch/arm/include/asm/setup.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tag_header</span> &#123;</span></span><br><span class="line">    u32 <span class="built_in">size</span>;</span><br><span class="line">    u32 tag;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>


<p>这个链表必须以tag_header.tag = ATAG_CORE开始，以tag_header.tag = ATAG_NONE结束；</p>
<h4 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// arch/arm/lib/bootm.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">boot_prep_linux</span><span class="params">(<span class="keyword">bootm_headers_t</span> *images)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *commandline = env_get(<span class="string">"bootargs"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (IMAGE_ENABLE_OF_LIBFDT &amp;&amp; images-&gt;ft_len) &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_OF_LIBFDT</span></span><br><span class="line">        debug(<span class="string">"using: FDT\n"</span>);</span><br><span class="line">        <span class="keyword">if</span> (image_setup_linux(images)) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"FDT creation failed! hanging..."</span>);</span><br><span class="line">            hang();</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (BOOTM_ENABLE_TAGS) &#123;</span><br><span class="line">        debug(<span class="string">"using: ATAGS\n"</span>);</span><br><span class="line">        setup_start_tag(gd-&gt;bd);</span><br><span class="line">        <span class="keyword">if</span> (BOOTM_ENABLE_SERIAL_TAG)</span><br><span class="line">            setup_serial_tag(&amp;params);</span><br><span class="line">        <span class="keyword">if</span> (BOOTM_ENABLE_CMDLINE_TAG)</span><br><span class="line">            setup_commandline_tag(gd-&gt;bd, commandline);</span><br><span class="line">        <span class="keyword">if</span> (BOOTM_ENABLE_REVISION_TAG)</span><br><span class="line">            setup_revision_tag(&amp;params);</span><br><span class="line">        <span class="keyword">if</span> (BOOTM_ENABLE_MEMORY_TAGS)</span><br><span class="line">            setup_memory_tags(gd-&gt;bd);</span><br><span class="line">        <span class="keyword">if</span> (BOOTM_ENABLE_INITRD_TAG) &#123;</span><br><span class="line">            <span class="keyword">if</span> (images-&gt;initrd_start &amp;&amp; images-&gt;initrd_end) &#123;</span><br><span class="line">                setup_initrd_tag(gd-&gt;bd, images-&gt;initrd_start,</span><br><span class="line">                         images-&gt;initrd_end);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (images-&gt;rd_start &amp;&amp; images-&gt;rd_end) &#123;</span><br><span class="line">                setup_initrd_tag(gd-&gt;bd, images-&gt;rd_start,</span><br><span class="line">                         images-&gt;rd_end);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        setup_board_tags(&amp;params);</span><br><span class="line">        setup_end_tag(gd-&gt;bd);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"FDT and ATAGS support not compiled in - hanging\n"</span>);</span><br><span class="line">        hang();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/u-boot/" rel="tag"># u-boot</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/04/19/Linux%E5%9D%97%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8/" rel="prev" title="Linux块设备驱动">
      <i class="fa fa-chevron-left"></i> Linux块设备驱动
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/04/19/Linux%E5%86%85%E6%A0%B8%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B-%E5%9F%BA%E4%BA%8EARM64/" rel="next" title="Linux内核启动流程-基于ARM64">
      Linux内核启动流程-基于ARM64 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="gitalk-container"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#u-boot引导kernel启动过程"><span class="nav-text">u-boot引导kernel启动过程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#目录"><span class="nav-text">目录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#bootm命令"><span class="nav-text">bootm命令</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#do-bootm"><span class="nav-text">do_bootm</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#do-bootm-states"><span class="nav-text">do_bootm_states</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#bootm-start"><span class="nav-text">bootm_start</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#bootm-find-os"><span class="nav-text">bootm_find_os</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#boot-get-kernel"><span class="nav-text">boot_get_kernel</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#image"><span class="nav-text">image</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#do-bootm-linux"><span class="nav-text">do_bootm_linux</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#u-boot给Kernel传参"><span class="nav-text">u-boot给Kernel传参</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#应用"><span class="nav-text">应用</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">micro虾米</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">17</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">micro虾米</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>


  <script src='https://unpkg.com/mermaid@7.1.2/dist/mermaid.min.js'></script>
  <script>
    if (window.mermaid) {
      mermaid.initialize({theme: 'forest'});
    }
  </script>


        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  













<script>
if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme    : 'forest',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    });
  }, window.mermaid);
}
</script>


  

  

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : '1ec7eee73ee4f91e15a1',
      clientSecret: '971b3c9439c2a8fa2fcb12307657ad50aee6ed0c',
      repo        : 'mshrimp_blog_talk',
      owner       : 'mshrimp',
      admin       : ['mshrimp'],
      id          : '32f3fd746af89696f9be8e34570a858b',
        language: '',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script>

</body>
</html>
